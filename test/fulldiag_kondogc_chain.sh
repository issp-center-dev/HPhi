#!/bin/sh -e

mkdir -p fulldiag_kondogc_chain/
cd fulldiag_kondogc_chain

cat > stan.in <<EOF
L = 2
model = "KondoGC"
method = "FullDiag"
lattice = "chain"
t = 1.0
J = 4.0
ScaLAPACK = 1
EOF

${MPIRUNFC} ../../src/HPhi -s stan.in

# Check value

cat > reference.dat <<EOF
  <H>         <N>        <Sz>       <S2>       <D>
  -6.744563   4.000000   0.000000   1.561465   0.119442
  -4.472136   4.000000   0.000000   0.950000   0.400000
  -4.472136   4.000000   0.100000   0.275000   0.400000
  -4.472136   4.000000  -0.100000   0.275000   0.400000
  -4.464102   5.000000  -0.122008   1.033494   1.000000
  -4.464102   3.000000   0.106566   0.941463   0.000000
  -4.464102   5.000000   0.122008   1.033494   1.000000
  -4.464102   3.000000  -0.106566   1.125524   0.000000
  -3.000000   3.000000   0.332976   1.394286   0.000000
  -3.000000   3.000000  -0.332976   1.355714   0.000000
  -3.000000   5.000000  -0.333333   1.375000   1.000000
  -3.000000   5.000000   0.333333   1.375000   1.000000
  -2.000000   4.000000  -0.419735   2.395240   0.048964
  -2.000000   4.000000   0.445247   1.977195   0.066378
  -2.000000   4.000000  -0.416641   1.447986   0.359526
  -2.000000   4.000000   0.391129   2.242079   0.025132
  -1.000000   4.999863   0.499213   0.751166   0.999932
  -1.000000   4.999998   0.167411   1.248883   0.999999
  -1.000000   3.000000  -0.390769   0.752850   0.000000
  -1.000000   5.000000  -0.500000   0.750000   1.000000
  -1.000000   5.000000  -0.166667   1.250000   1.000000
  -1.000000   3.000000   0.388033   0.761242   0.000000
  -1.000000   3.000000   0.119843   0.998800   0.000000
  -1.000000   3.000138  -0.117064   1.487059   0.000069
  -0.000000   4.000000  -0.028956   1.258163   0.535950
  -0.000000   4.000000   0.133333   0.366667   0.866667
  -0.000000   4.000000  -0.133333   0.366667   0.866667
   0.000000   4.000000   0.336292   1.894447   0.347478
   0.000000   2.000000   0.500000   0.750000   0.000000
   0.000000   2.000000   0.000000   0.000000   0.000000
   0.000000   2.000000  -0.500000   0.750000   0.000000
   0.000000   2.000000   0.000000   0.000000   0.000000
   0.000000   6.000000   0.000000   0.000000   2.000000
   0.000000   6.000000   0.500000   0.750000   2.000000
   0.000000   6.000000  -0.500000   0.750000   2.000000
   0.000000   6.000000   0.000000   0.000000   2.000000
   0.000000   4.000000   0.263954   1.233238   0.828825
   0.000000   4.000000  -0.286383   1.232783   0.711639
   0.000000   4.000000  -0.284907   1.898035   0.442775
   1.000000   3.000000   0.000000   0.876673   0.000000
   1.000000   5.000000   0.000000   1.125000   1.000000
   1.000000   3.000000  -0.000000   1.373327   0.000000
   1.000000   5.000000   0.000000   1.125000   1.000000
   2.000000   4.000000  -0.253528   2.169726   0.000000
   2.000000   4.000000   0.845399   2.090126   0.000000
   2.000000   4.000000   0.591832   2.291955   0.000000
   2.000000   4.000000  -0.488807   2.506630   0.000000
   2.000000   4.000000  -0.694896   2.191563   0.000000
   2.464102   3.000000   0.436037   1.604120   0.000000
   2.464102   3.000000  -0.436037   1.328893   0.000000
   2.464102   5.000000  -0.455342   1.466506   1.000000
   2.464102   5.000000   0.455342   1.466506   1.000000
   3.000000   4.999443   0.175036   1.237033   0.999721
   3.000000   3.000000   0.482801   0.779107   0.000000
   3.000000   4.741996   0.364354   0.762536   0.870998
   3.000000   5.000000  -0.166667   1.250000   1.000000
   3.000000   5.000000  -0.500000   0.750000   1.000000
   3.000000   3.000000   0.170493   1.313201   0.000000
   3.000000   3.258355  -0.363776   0.753626   0.129178
   3.000000   3.000206  -0.162243   1.154497   0.000103
   4.472136   4.000000  -0.000000   0.950000   0.400000
   4.472136   4.000000   0.100000   0.275000   0.400000
   4.472136   4.000000  -0.100000   0.275000   0.400000
   4.744563   4.000000   0.000000   0.876035   0.380558
EOF
paste output/zvo_phys.dat reference.dat > paste.dat
diff=`awk '
BEGIN{diff=0.0} 
NR>1{diff+=sqrt(($1-$6)*($1-$6))} 
END{printf "%8.6f", diff/NR}
' paste.dat`
test "${diff}" = "0.000000"

exit $?
