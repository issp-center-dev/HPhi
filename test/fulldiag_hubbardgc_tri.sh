#!/bin/sh -e

mkdir -p fulldiag_hubbardgc_tri/
cd fulldiag_hubbardgc_tri

cat > stan.in <<EOF
a0w = 1
a0l = 1
a1w = -1
a1l = 2
model = "HubbardGC"
method = "FullDiag"
lattice = "Triangular"
t = 1.0
U = 4.0
ScaLAPACK = 1
EOF

${MPIRUNFC} ../../src/HPhi -s stan.in

# Check value

cat > reference.dat <<EOF
  <H>         <N>        <Sz>       <S2>       <D>
 -10.848858   2.000000   0.000000   0.000000   0.246163
  -6.652242   3.000000   0.352358   0.750000   0.503595
  -6.652242   3.000000  -0.283849   0.750000   0.503595
  -6.652242   3.000000   0.254392   0.750000   0.503595
  -6.652242   3.000000  -0.322901   0.750000   0.503595
  -6.000000   1.000000   0.500000   0.750000   0.000000
  -6.000000   1.000000  -0.500000   0.750000   0.000000
  -3.000000   2.000000  -0.000756   2.000000   0.000000
  -3.000000   2.000000  -0.387334   2.000000   0.000000
  -3.000000   2.000000   0.853282   2.000000   0.000000
  -3.000000   2.000000   0.549916   2.000000   0.000000
  -3.000000   2.000000  -0.973303   2.000000   0.000000
  -3.000000   2.000000  -0.041804   2.000000   0.000000
  -2.000000   4.000000  -0.468932   2.000000   1.000000
  -2.000000   4.000000   0.443305   2.000000   1.000000
  -2.000000   4.000000   0.025627   2.000000   1.000000
  -1.000000   4.000000  -0.000000   0.000000   1.181818
  -1.000000   4.000000  -0.000000   0.000000   1.181818
  -0.772002   2.000000  -0.000000   0.000000   0.441479
  -0.772002   2.000000  -0.000000  -0.000000   0.441479
   0.000000   3.000000  -0.498678   3.750000   0.000000
   0.000000   3.000000   0.467476   3.750000   0.000000
   0.000000   3.000000  -1.455387   3.750000   0.000000
   0.000000   0.000000   0.000000   0.000000   0.000000
  -0.000000   3.000000   1.486589   3.750000   0.000000
   0.455996   4.000000  -0.000000  -0.000000   1.558521
   2.721581   3.000000   0.464016   0.750000   0.706159
   2.721581   3.000000   0.497479   0.750000   0.706159
   2.721581   3.000000  -0.492565   0.750000   0.706159
   2.721581   3.000000  -0.468930   0.750000   0.706159
   3.000000   1.000000   0.469222   0.750000   0.000000
   3.000000   1.000000  -0.499999   0.750000   0.000000
   3.000000   1.000000  -0.469223   0.750000   0.000000
   3.000000   1.000000   0.500000   0.750000   0.000000
   4.000000   3.000000  -0.327316   0.750000   1.000000
   4.000000   3.000000  -0.499626   0.750000   1.000000
   4.000000   3.000000   0.456707   0.750000   1.000000
   4.000000   3.000000   0.370235   0.750000   1.000000
   5.000000   5.000000  -0.456370   0.750000   2.000000
   5.000000   5.000000  -0.500000   0.750000   2.000000
   5.000000   5.000000   0.500000   0.750000   2.000000
   5.000000   5.000000   0.456370   0.750000   2.000000
   6.000000   2.000000   0.905203   2.000000   0.000000
   6.000000   2.000000  -0.894223   2.000000   0.000000
   6.000000   2.000000  -0.010980   2.000000   0.000000
   7.000000   4.000000  -0.548516   2.000000   1.000000
   7.000000   4.000000   0.305128   2.000000   1.000000
   7.000000   4.000000  -0.217676   2.000000   1.000000
   7.000000   4.000000  -0.269973   2.000000   1.000000
   7.000000   4.000000   0.296161   2.000000   1.000000
   7.000000   4.000000   0.434876   2.000000   1.000000
   7.772002   2.000000  -0.000000   0.000000   0.558521
   7.772002   2.000000   0.000000  -0.000000   0.558521
   8.848858   2.000000   0.000000   0.000000   0.753837
  10.000000   4.000000  -0.000000   0.000000   1.818182
  10.000000   4.000000   0.000000   0.000000   1.818182
  11.930661   3.000000  -0.252997   0.750000   0.790247
  11.930661   3.000000   0.127074   0.750000   0.790247
  11.930661   3.000000  -0.347717   0.750000   0.790247
  11.930661   3.000000   0.473641   0.750000   0.790247
  12.000000   6.000000   0.000000   0.000000   3.000000
  14.000000   5.000000  -0.500000   0.750000   2.000000
  14.000000   5.000000   0.500000   0.750000   2.000000
  17.544004   4.000000   0.000000   0.000000   1.441479
EOF
paste output/zvo_phys.dat reference.dat > paste.dat
diff=`awk '
BEGIN{diff=0.0} 
NR>1{diff+=sqrt(($1-$6)*($1-$6))} 
END{printf "%8.6f", diff/NR}
' paste.dat`
test "${diff}" = "0.000000"

exit $?
