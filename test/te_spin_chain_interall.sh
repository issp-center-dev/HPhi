#!/bin/sh -e

mkdir -p te_spin_chain_interall/
cd te_spin_chain_interall
python3 "$1/test/testTECalc.py" -p "../../src/HPhi" -mpi "${MPIRUN}" -m "Spin"

# Check value: SS
cat > reference.dat <<EOF
0.0000000000000000  -8.5192179541868320 74.0623555359274235 0.0000000000000000 8.0000000000000000 0
0.0100000000000000  -8.5207760318075909 74.0793702831773402 0.0000000000000000 8.0000000000000000 1
0.0200000000000000  -8.5223241688979581 74.0962776964661458 0.0000000000000000 8.0000000000000000 2
0.0300000000000000  -8.5238624243517975 74.1130784023786475 0.0000000000000000 8.0000000000000000 3
0.0400000000000000  -8.5253908567773387 74.1297730245369451 0.0000000000000000 8.0000000000000000 4
0.0500000000000000  -8.5269095244976292 74.1463621836044098 0.0000000000000000 8.0000000000000000 5
0.0600000000000000  -8.5284184855510770 74.1628464972903032 0.0000000000000000 8.0000000000000000 6
0.0700000000000000  -8.5299177976919491 74.1792265803544666 0.0000000000000000 8.0000000000000000 7
0.0800000000000000  -8.5314075183909939 74.1955030446126358 0.0000000000000000 8.0000000000000000 8
0.0900000000000000  -8.5328877048358596 74.2116764989400366 0.0000000000000000 8.0000000000000000 9
0.1000000000000000  -8.5343584139318143 74.2277475492782060 0.0000000000000000 8.0000000000000000 10
0.1100000000000000  -8.5358197023022147 74.2437167986388573 0.0000000000000000 8.0000000000000000 11
0.1200000000000000  -8.5372716262891331 74.2595848471098776 0.0000000000000000 8.0000000000000000 12
0.1300000000000000  -8.5387142419539508 74.2753522918605569 0.0000000000000000 8.0000000000000000 13
0.1400000000000000  -8.5401476050780172 74.2910197271475568 0.0000000000000000 8.0000000000000000 14
0.1500000000000000  -8.5415717711632091 74.3065877443201970 0.0000000000000000 8.0000000000000000 15
0.1600000000000000  -8.5429867954325829 74.3220569318264950 0.0000000000000000 8.0000000000000000 16
0.1700000000000000  -8.5443927328310565 74.3374278752192623 0.0000000000000000 8.0000000000000000 17
0.1800000000000000  -8.5457896380260081 74.3527011571618459 0.0000000000000000 8.0000000000000000 18
0.1900000000000000  -8.5471775654080009 74.3678773574348213 0.0000000000000000 8.0000000000000000 19
0.2000000000000000  -8.5485565690913869 74.3829570529419755 0.0000000000000000 8.0000000000000000 20
0.2100000000000000  -8.5499267029150836 74.3979408177167585 0.0000000000000000 8.0000000000000000 21
0.2200000000000000  -8.5512880204431916 74.4128292229290764 0.0000000000000000 8.0000000000000000 22
0.2300000000000000  -8.5526405749657162 74.4276228368913451 0.0000000000000000 8.0000000000000000 23
0.2400000000000000  -8.5539844194993027 74.4423222250659080 0.0000000000000000 8.0000000000000000 24
0.2500000000000000  -8.5553196067879327 74.4569279500715595 0.0000000000000000 8.0000000000000000 25
0.2600000000000000  -8.5566461893036845 74.4714405716905077 0.0000000000000000 8.0000000000000000 26
0.2700000000000000  -8.5579642192474239 74.4858606468753237 0.0000000000000000 8.0000000000000000 27
0.2800000000000000  -8.5592737485495931 74.5001887297561893 0.0000000000000000 8.0000000000000000 28
0.2900000000000000  -8.5605748288709549 74.5144253716483149 0.0000000000000000 8.0000000000000000 29
0.3000000000000000  -8.5618675116033245 74.5285711210587181 0.0000000000000000 8.0000000000000000 30
0.3100000000000000  -8.5631518478703939 74.5426265236943522 0.0000000000000000 8.0000000000000000 31
0.3200000000000000  -8.5644278885284670 74.5565921224687997 0.0000000000000000 8.0000000000000000 32
0.3300000000000000  -8.5656956841672685 74.5704684575106000 0.0000000000000000 8.0000000000000000 33
0.3400000000000000  -8.5669552851107049 74.5842560661702976 0.0000000000000000 8.0000000000000000 34
0.3500000000000000  -8.5682067414176846 74.5979554830286276 0.0000000000000000 8.0000000000000000 35
0.3600000000000000  -8.5694501028829428 74.6115672399040477 0.0000000000000000 8.0000000000000000 36
0.3700000000000000  -8.5706854190378063 74.6250918658608100 0.0000000000000000 8.0000000000000000 37
0.3800000000000000  -8.5719127391510526 74.6385298872167908 0.0000000000000000 8.0000000000000000 38
0.3900000000000000  -8.5731321122297022 74.6518818275514349 0.0000000000000000 8.0000000000000000 39
0.4000000000000000  -8.5743435870198841 74.6651482077144664 0.0000000000000000 8.0000000000000000 40
0.4100000000000000  -8.5755472120076366 74.6783295458331224 0.0000000000000000 8.0000000000000000 41
0.4200000000000000  -8.5767430354197600 74.6914263573211628 0.0000000000000000 8.0000000000000000 42
0.4300000000000000  -8.5779311052247067 74.7044391548869697 0.0000000000000000 8.0000000000000000 43
0.4400000000000000  -8.5791114691333377 74.7173684485416345 0.0000000000000000 8.0000000000000000 44
0.4500000000000000  -8.5802841745998908 74.7302147456079240 0.0000000000000000 8.0000000000000000 45
0.4600000000000000  -8.5814492688227677 74.7429785507282816 0.0000000000000000 8.0000000000000000 46
0.4700000000000000  -8.5826067987454007 74.7556603658735241 0.0000000000000000 8.0000000000000000 47
0.4800000000000000  -8.5837568110572224 74.7682606903519940 0.0000000000000000 8.0000000000000000 48
0.4900000000000000  -8.5848993521943893 74.7807800208171045 0.0000000000000000 8.0000000000000000 49
0.5000000000000000  -8.5860344683407934 74.7932188512772456 0.0000000000000000 8.0000000000000000 50
0.5100000000000000  -8.5871622054288803 74.8055776731037128 0.0000000000000000 8.0000000000000000 51
0.5200000000000000  -8.5882826091405828 74.8178569750401721 0.0000000000000000 8.0000000000000000 52
0.5300000000000000  -8.5893957249081634 74.8300572432109021 0.0000000000000000 8.0000000000000000 53
0.5400000000000000  -8.5905015979151464 74.8421789611301875 0.0000000000000000 8.0000000000000000 54
0.5500000000000000  -8.5916002730972227 74.8542226097111580 0.0000000000000000 8.0000000000000000 55
0.5600000000000001  -8.5926917951431445 74.8661886672747272 0.0000000000000000 8.0000000000000000 56
0.5700000000000000  -8.5937762084956049 74.8780776095586873 0.0000000000000000 8.0000000000000000 57
0.5800000000000000  -8.5948535573522307 74.8898899097269606 0.0000000000000000 8.0000000000000000 58
0.5900000000000000  -8.5959238856664228 74.9016260383785379 0.0000000000000000 8.0000000000000000 59
0.6000000000000000  -8.5969872371482658 74.9132864635565028 0.0000000000000000 8.0000000000000000 60
0.6100000000000000  -8.5980436552655544 74.9248716507578507 0.0000000000000000 8.0000000000000000 61
0.6200000000000000  -8.5990931832445927 74.9363820629421156 0.0000000000000000 8.0000000000000000 62
0.6300000000000000  -8.6001358640711842 74.9478181605409759 0.0000000000000000 8.0000000000000000 63
0.6400000000000000  -8.6011717404915622 74.9591804014674921 0.0000000000000000 8.0000000000000000 64
0.6500000000000000  -8.6022008550132973 74.9704692411254285 0.0000000000000000 8.0000000000000000 65
0.6600000000000000  -8.6032232499062680 74.9816851324186757 0.0000000000000000 8.0000000000000000 66
0.6700000000000000  -8.6042389672035533 74.9928285257607286 0.0000000000000000 8.0000000000000000 67
0.6800000000000000  -8.6052480487024159 75.0038998690841225 0.0000000000000000 8.0000000000000000 68
0.6899999999999999  -8.6062505359651844 75.0148996078495855 0.0000000000000000 8.0000000000000000 69
0.7000000000000000  -8.6072464703202769 75.0258281850560564 0.0000000000000000 8.0000000000000000 70
0.7100000000000000  -8.6082358928630693 75.0366860412498511 0.0000000000000000 8.0000000000000000 71
0.7200000000000000  -8.6092188444568905 75.0474736145342405 0.0000000000000000 8.0000000000000000 72
0.7300000000000000  -8.6101953657339276 75.0581913405789720 0.0000000000000000 8.0000000000000000 73
0.7400000000000000  -8.6111654970962501 75.0688396526303876 0.0000000000000000 8.0000000000000000 74
0.7500000000000000  -8.6121292787166546 75.0794189815200639 0.0000000000000000 8.0000000000000000 75
0.7600000000000000  -8.6130867505396989 75.0899297556751293 0.0000000000000000 8.0000000000000000 76
0.7700000000000000  -8.6140379522826542 75.1003724011280696 0.0000000000000000 8.0000000000000000 77
0.7800000000000000  -8.6149829234363793 75.1107473415257090 0.0000000000000000 8.0000000000000000 78
0.7900000000000000  -8.6159217032663857 75.1210549981393001 0.0000000000000000 8.0000000000000000 79
0.8000000000000000  -8.6168543308137053 75.1312957898743008 0.0000000000000000 8.0000000000000000 80
0.8100000000000001  -8.6177808448958864 75.1414701332797819 0.0000000000000000 8.0000000000000000 81
0.8200000000000000  -8.6187012841079653 75.1515784425585167 0.0000000000000000 8.0000000000000000 82
0.8300000000000000  -8.6196156868233746 75.1616211295761900 0.0000000000000000 8.0000000000000000 83
0.8400000000000000  -8.6205240911949570 75.1715986038717574 0.0000000000000000 8.0000000000000000 84
0.8500000000000000  -8.6214265351558979 75.1815112726667678 0.0000000000000000 8.0000000000000000 85
0.8600000000000000  -8.6223230564206776 75.1913595408750837 0.0000000000000000 8.0000000000000000 86
0.8700000000000000  -8.6232136924860487 75.2011438111131127 0.0000000000000000 8.0000000000000000 87
0.8800000000000000  -8.6240984806319858 75.2108644837091589 0.0000000000000000 8.0000000000000000 88
0.8900000000000000  -8.6249774579226486 75.2205219567130712 0.0000000000000000 8.0000000000000000 89
0.9000000000000000  -8.6258506612073482 75.2301166259066463 0.0000000000000000 8.0000000000000000 90
0.9100000000000000  -8.6267181271214888 75.2396488848128371 0.0000000000000000 8.0000000000000000 91
0.9200000000000000  -8.6275798920875566 75.2491191247059135 0.0000000000000000 8.0000000000000000 92
0.9300000000000000  -8.6284359923160512 75.2585277346209409 0.0000000000000000 8.0000000000000000 93
0.9399999999999999  -8.6292864638064746 75.2678751013639555 0.0000000000000000 8.0000000000000000 94
0.9500000000000000  -8.6301313423482497 75.2771616095213147 0.0000000000000000 8.0000000000000000 95
0.9600000000000000  -8.6309706635217101 75.2863876414698439 0.0000000000000000 8.0000000000000000 96
0.9700000000000000  -8.6318044626990584 75.2955535773867553 0.0000000000000000 8.0000000000000000 97
0.9800000000000000  -8.6326327750453427 75.3046597952588854 0.0000000000000000 8.0000000000000000 98
0.9900000000000000  -8.6334556355193310 75.3137066708929552 0.0000000000000000 8.0000000000000000 99
EOF
sed -e "1d" output/SS.dat > ss.dat
paste ss.dat reference.dat > paste1.dat
diff=`awk 'BEGIN{diff=0.0} {diff+=sqrt(($2-$8)*($2-$8))} END{printf "%8.6f", diff}' paste1.dat`
diff=`awk 'BEGIN{diff='${diff}'} {diff+=sqrt(($3-$9)*($3-$9))} END{printf "%8.6f", diff}' paste1.dat`
diff=`awk 'BEGIN{diff='${diff}'} {diff+=sqrt(($4-$10)*($4-$10))} END{printf "%8.6f", diff}' paste1.dat`
diff=`awk 'BEGIN{diff='${diff}'} {diff+=sqrt(($5-$11)*($5-$11))} END{printf "%8.6f", diff}' paste1.dat`

test "${diff}" = "0.000000"
exit $?
